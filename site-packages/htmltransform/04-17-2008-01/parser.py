import tidy
from xml.dom.minidom import parseString
import urllib2
import urllib
import tempfile
import os
import dialects

def parse(url, dialect=None, cls=None, tionary={}):
    '''
    Parses the HTML specified by @url and converts it on basis of @dialect specified.
    '''
    if url[0] == '/':
        url = 'file://'+url
    f = urllib2.urlopen(url)
    con = ''.join(f.readlines())
    docs = [parseString(d) for d in con.split('\x00')]
    for root in docs:
        walk(root)
        content = ''
        if dialect == None and cls == None:
            return
        elif dialect != None:
            flag = False
            for i in dialects.__all__:
                if dialect == i:
                    flag = True
            if flag == True:
                a = getattr(dialects, dialect)
                trans = a(root, **tionary)
                content = str(trans)
            else:
                content = ''
        elif cls != None:
            trans = cls(root, tionary)
            content = str(trans)
    return content

def walk(root):
    root.tag = root.tag.split('}')[1]
    root.text = et._encode(root.text, "utf-8")
    root.tail = et._encode(root.tail, "utf-8")
    if root.text == '\n':
        root.text = ''
    if root.tail == '\n':
        root.tail = ''
    for i in root.getchildren():
        walk(i)

    

if __name__=='__main__':
    #b = mediawiki('test')
    #a = parse(b)
    import sys
    d = parse(sys.argv[1], dialect=sys.argv[2])
    print d
    
